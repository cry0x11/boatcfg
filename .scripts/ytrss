#!/bin/bash

source ~/.scripts/cmdfns
    
if ! [ -f ~/.scripts/ytsubs ]; then
    touch ~/.scripts/ytsubs
fi

function updater {
    if ! [ -f ~/.cache/boatcfg/scripts/tmp ]; then
        mkdir -p ~/.cache/boatcfg/scripts/tmp
    fi
    
    rm ~/.cache/boatcfg/scripts/tmp/*

    cat ~/.scripts/files/ytsubs |\
        sed 's/=/={/g; s/$/}/g' |\
        xargs -P 0 -I {} curl -s {} --output ~/.cache/boatcfg/scripts/tmp/'#1'

    if [ $? -ne 0 ]; then
        notifier normal \
                 "dialog-error" \
                 "Ytrss" \
                 "Cannot fetch feed, There seems to be a network error"
        exit 1
    fi

    cat ~/.cache/boatcfg/scripts/tmp/* |\
            awk '/<entry>/,/<\/entry>/' |\
            grep --no-group-separator --color=never -A 10 href |\
            sed '/author>/d; /<uri>/d; /<name>/d; /<media:group>/d; /<media:content url=/d; /<updated>/d; s/.*href="//g; s/.*<media:thumbnail url="//g; s/".*$//g; s/.*<published>//g; s/<\/published>.*$//g; s/^.*<media:title>//g; s/<\/media:title>.*$//g; s/&quot;/"/g' |\
            perl -pe 's/\n/;;;/g if $. % 4' |\
            awk -F ';;;' '{t=$1; $1=$2; $2=t; print $1";;;"$2";;;"$3";;;"$4 ;}' > ~/.cache/boatcfg/scripts/ytrss

    notifier normal \
        "application-rss+xml" \
        "Ytrss" \
        "Feed updated successfully"
}

case $1 in
    view)
        if ! [ -f ~/.cache/boatcfg/scripts/ytrss ]; then
            clear
            echo "Updating feed..."
            updater
        fi

        choice=`cat ~/.cache/boatcfg/scripts/ytrss |\
            sort -r |\
            awk -F ';;;' '{ printf "%s\n", $3}' |\
            fzfcmd --preview-window=right:55% \
                   --preview="~/.scripts/files/ytrss-preview {}"`

        choiceUrl=`grep ";;;$choice" ~/.cache/boatcfg/scripts/ytrss | awk -F ';;;' '{print $2}'`

        if [ -n "$choice" ]; then
            nohup bash -c "source ~/.scripts/cmdfns; mpvcmd $choiceUrl &" 2&>/dev/null
        fi
        ;;

    update)
        updater
        ;;

    add)
        yturl=`wl-paste`
        if [ -n "$yturl" ]; then
            if [[ $yturl =~ ^"https://www.youtube.com/" ]]; then
                rssurl=`curl -s "$yturl" |\
                            grep '"rssUrl":' |\
                            sed 's/^.*"rssUrl"://g; s/",".*$//g; s/.*http/http/g; s/channel_id=UC/playlist_id=UU/g'`
                if grep -q $rssurl ~/.scripts/files/ytsubs; then
                    notifier normal \
                    "dialog-error" \
                    "Ytrss" \
                    "Feed already exists"
                else
                    echo $rssurl >> ~/.scripts/files/ytsubs
                    notifier normal \
                    "application-rss+xml" \
                    "Ytrss" \
                    "Feed added successfully" \
                    "<b>$yturl</b>"
                fi
            else
                notifier normal \
                "dialog-error" \
                "Ytrss" \
                "Not a youtube url" \
                "<b>Please copy the url of a youtube channel to your clipboard</b>"
            fi
        fi
        ;;
esac
